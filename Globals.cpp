#include "Globals.h"

__m256 XP[AVX_SV];
__m256 X[AVX_SV];
__m256 F[AVX_SV];
__m256 V[AVX_SV];

float* x_ptr;
float* xp_ptr;
float* f_ptr;
float* v_ptr;

int string_starts[NB_STRINGS];
int string_ends[NB_STRINGS];
int string_size[NB_STRINGS];

int string_start_vec[AVX_SV];
int string_end_vec[AVX_SV];

__m256 str_invM[AVX_SV];
__m256 str_K[AVX_SV];
__m256 str_Z[AVX_SV];

float* k_ptr;
float* z_ptr;
float* m_ptr;

float damper_hard = 0.1;
float damper_soft = 0.004;



std::array<float, NB_STRINGS> excitation;

std::array<float, NB_STRINGS> damping_old
= { 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001 };


// FOR STIFFER AND BIGGER HARP USE PARAM SET BELOW

std::array<int, NB_STRINGS> nbMasses_big = { 617, 583, 519, 462, 436, 389, 346, 308, 291, 259, 231, 218, 194, 173, 154, 145, 129, 115, 109, 97, 86, 77, 72, 64, 57, 54, 48, 43, 38, 36, 32, 28, 27, 24, 21, 19, 18, 16, 14, 13, 12, 10, 7, 7, 6, 5, 5 };

std::array<float, NB_STRINGS> stiffness_big
= { 0.7485195340398878, 0.7502697743061393, 0.7494307830711584, 0.7485521354754302, 0.7484990020336019, 0.7510956057493011, 0.7491414930340992, 0.7484481897473159, 0.7502063338215402, 0.7493811242650813, 0.751750336645135, 0.7518944826738002, 0.7510697414288666, 0.7534462797934022, 0.7532868249558533, 0.7501955573636025, 0.7493751356573802, 0.7517486652053007, 0.7587767929365162, 0.7587970617315861, 0.7534556658591102, 0.7630513827728506, 0.7502131987875255, 0.7493993443332346, 0.7517803286902907, 0.7588118175681773, 0.7588422595101224, 0.770928946430779, 0.763123561329689, 0.7709831189162523, 0.7727293358419717, 0.751916606942825, 0.7867797507111884, 0.7902840166410449, 0.7711538031210625, 0.8029824856099335, 0.8134552118093038, 0.8205499613410291, 0.8050469311514606, 0.787308579436578, 0.855140478637396, 0.7720562872855856, 0.5169267538863418, 0.579761085181759, 0.560382012400402, 0.5206197572924087, 0.5835325921809693 };

// FOR SLIGHTLY SMALLER, USE THIS SET:

std::array<int, NB_STRINGS> nbMasses_reg = { 505, 477, 424, 378, 357, 318, 283, 252, 238, 212, 189, 178, 159, 141, 126, 119, 106, 94, 89, 79, 70,
	63, 59, 53, 47, 44, 39, 35, 31, 29, 26, 23, 22, 19, 17, 15, 14, 13, 11, 11, 9, 8, 7, 7, 6, 5, 5 };

std::array<float, NB_STRINGS> stiffness_reg
= { 0.5017965624702695, 0.5026296056527185, 0.5006144224980299, 0.501578961593505, 0.5023371780173816, 0.5025144272777269,
	0.5018143135730394, 0.5017503281406773, 0.5025888963109987, 0.5029419366696886, 0.5042061302522952, 0.5023176412756534,
	0.5056564689405864, 0.5018066375846744, 0.5057218241058545, 0.5068031628694446, 0.5076801614599321, 0.5042163577016581,
	0.507958539961229, 0.5056756982315244, 0.5018333989126285, 0.5137514047002292, 0.5068432586547559, 0.5172637790655372,
	0.5149514659789758, 0.5080331476725229, 0.5057708726034386, 0.5161846934885025, 0.5139011633312927, 0.5070139594137083,
	0.5174746206917571, 0.5152186959021426, 0.5311442205526943, 0.5061564256031881, 0.5166604920335384, 0.5145038323932211,
	0.5077002618428629, 0.5572500582102576, 0.5162915208682666, 0.5793088340482621, 0.5077045251717259, 0.5185717702828456,
	0.5169267538863418, 0.579761085181759, 0.560382012400402, 0.5206197572924087, 0.5835325921809693 };


std::array<int, NB_STRINGS> nbMasses_min = { 269, 254, 226, 201, 190, 169, 151, 134, 127, 113, 100, 95, 84, 75, 67, 63, 56, 50, 47, 42,
	37, 33, 31, 28, 25, 23, 21, 18, 16, 15, 14, 12, 11, 10, 9, 8, 7, 7, 6, 5, 5, 4, 4, 3, 3, 3, 3 };

std::array<float, NB_STRINGS> stiffness_min = { 0.14287547301442063, 0.14304627832448827, 0.14281774314440365, 0.1424852465239372, 0.1429891244756881, 0.1427163930863357,
	0.1437489139772619, 0.14286576749287078, 0.14416258963122022, 0.14407477748650147, 0.1424848824639729, 0.14449154840532524,
	0.14272134829663444, 0.14375766983391589, 0.14500306495748908, 0.144178058921103, 0.1440957235667886, 0.14534758739801643,
	0.14452289779741195, 0.14613908981138243, 0.14380916894810136, 0.14506836414624522, 0.1442516392276992, 0.14928728247617148,
	0.1512181564112648, 0.1446549574644056, 0.15317717789717156, 0.14401952452961023, 0.14533323852120456, 0.14454936515863998,
	0.16011872289713627, 0.15168764787785619, 0.14518638000403536, 0.15384060677036573, 0.1603734186790301, 0.16392764865147894,
	0.14574882676576456, 0.1835435705673137, 0.1776431975978202, 0.1473374087418593, 0.18547417836317365, 0.16375124214752595,
	0.2060325002974491, 0.15067499689676073, 0.18947268673529155, 0.23814078744349018, 0.2669182432177038 };



std::array<int, NB_STRINGS> nbMass_7k = { 369, 348, 310, 276, 261, 232, 207, 184, 174, 155, 138, 130, 116, 103, 92, 87, 77, 69, 65, 58, 51, 46, 43, 38, 34, 32, 29, 25, 23, 21, 19, 17, 16, 14, 12, 11, 10, 9, 8, 8, 7, 6, 5, 5, 4, 4, 4 };
std::array<float, NB_STRINGS> stiffness_7k = { 0.269453570196724, 0.26895746833717094, 0.2688605963523635, 0.2685442463319631, 0.2695922787347304, 0.2685053302341317, 0.2694927067850695, 0.2685205425811638, 0.2696668825281662, 0.2699314075286193, 0.2699642441628234, 0.26912973616535074, 0.27044929684139574, 0.26920794404934284, 0.2712086567434085, 0.27256138750139136, 0.2697848886303016, 0.2737533636169163, 0.27316298137273737, 0.2750319097332921, 0.2691788209528495, 0.27706737884886096, 0.2725715785976527, 0.2698231638406303, 0.2738199659426705, 0.2732456638303931, 0.2845467196884287, 0.2693399097941479, 0.28918287054061753, 0.2728112101466343, 0.2841328670669593, 0.29006301330489404, 0.2904763961622572, 0.2850996336127956, 0.2700552519928722, 0.2900618706275988, 0.2738225770038619, 0.2853898304909736, 0.2916368099377962, 0.3272332156766732, 0.3263597706735174, 0.31571817181038925, 0.29362962567286954, 0.3293213373393425, 0.29050454902259576, 0.3651237130790946, 0.4092460367838892 };
std::array<float, NB_STRINGS> damping_7k = { 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006 };

std::array<int, NB_STRINGS> nbMass_8k = { 417, 393, 350, 312, 294, 262, 234, 208, 196, 175, 156, 147, 131, 117, 104, 98, 87, 78, 73, 65, 58, 52, 49, 43, 39, 36, 32, 29, 26, 24, 21, 19, 18, 16, 14, 13, 12, 10, 9, 9, 8, 7, 6, 6, 5, 4, 4 };
std::array<float, NB_STRINGS> stiffness_8k = { 0.34390025101882987, 0.34278717603924164, 0.34246785901818494, 0.3428814415481791, 0.3417809084970085, 0.34209848510936763, 0.3439967052049633, 0.34270810232482785, 0.3417287436384696, 0.3435788422435288, 0.3444069885030107, 0.3435089192613736, 0.3442360915378826, 0.3465595218800607, 0.34570634321603955, 0.3449528167022276, 0.3433848841577635, 0.3486598210538461, 0.34338446267085, 0.3441488474269674, 0.34650438512578347, 0.35229532366693095, 0.3519440267214624, 0.343403742612927, 0.35758612372833615, 0.3434486016210201, 0.34424691896878634, 0.35848004460421934, 0.3658873763761222, 0.3521521338321588, 0.34367805774988514, 0.3579297310978891, 0.36263821886187125, 0.36589813229024964, 0.3591054108919868, 0.39420803877040256, 0.38170791732811404, 0.34482838570354646, 0.3593502210788701, 0.40321154391602126, 0.41193397287230626, 0.41074272149993524, 0.3972378150507897, 0.44552346581005, 0.4141190456048693, 0.36512371307909497, 0.40924603678388954 };
std::array<float, NB_STRINGS> damping_8k = {0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006};

std::array<int, NB_STRINGS> nbMass_9k = { 462, 436, 388, 346, 326, 291, 259, 231, 218, 194, 173, 163, 145, 129, 115, 109, 97, 86, 81, 72, 64, 57, 54, 48, 43, 40, 36, 32, 28, 27, 24, 21, 20, 18, 16, 14, 13, 12, 10, 10, 9, 8, 7, 6, 6, 5, 5 };
std::array<float, NB_STRINGS> stiffness_9k = { 0.421931095507098, 0.4216912270817624, 0.4206338796579589, 0.4214184782994889, 0.419950893071078, 0.4217007584847824, 0.42107947258060835, 0.42228555776211524, 0.4223140506960706, 0.4217626927577047, 0.42302735684624154, 0.4217928918831524, 0.421124499871121, 0.42062589763696207, 0.42192851328580605, 0.4258608847891885, 0.4258523492860564, 0.42284011631216095, 0.4216312565863141, 0.4210068828557985, 0.42054585312848014, 0.42188117418705323, 0.4258279567279186, 0.42584945552541464, 0.43264060681650146, 0.4216747398086785, 0.43269167120451074, 0.4336920524050872, 0.42203709712462706, 0.4416217320973244, 0.44362898915649907, 0.43294039181210425, 0.44281812973145923, 0.4567966579443052, 0.4608774745714251, 0.4522898582570087, 0.44239388566598176, 0.4806898188700483, 0.4341926144448201, 0.48718899880349603, 0.5075784646428299, 0.5184428238402973, 0.5167980680397382, 0.44552346581004854, 0.5602423272856941, 0.5204898997167151, 0.5833870028566641};
std::array<float, NB_STRINGS> damping_9k = { 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006 };

std::array<int, NB_STRINGS> nbMass_10k = { 505, 476, 424, 378, 357, 318, 283, 252, 238, 212, 189, 178, 159, 141, 126, 119, 106, 94, 89, 79, 70, 63, 59, 53, 47, 44, 39, 35, 31, 29, 26, 23, 22, 19, 17, 15, 14, 13, 11, 11, 9, 8, 7, 7, 6, 5, 5 };
std::array<float, NB_STRINGS> stiffness_10k = { 0.5039417197464168, 0.5024214233898457, 0.5020911011426458, 0.5027274104941868, 0.5033481812464783, 0.5032912340191581, 0.5024041279908691, 0.5021925264665608, 0.5029697994549888, 0.5032185302147496, 0.5044002065595374, 0.5024761930116666, 0.505757064471376, 0.5018599872208102, 0.505738410767057, 0.5068041456864791, 0.5076547543562396, 0.5041703197630315, 0.5079033630058098, 0.5056060158510626, 0.501752625179742, 0.5136592701660907, 0.5067484528241393, 0.5171603015393278, 0.514843139206142, 0.5079240765878366, 0.5056585981489873, 0.5160671190026076, 0.513781747654829, 0.5068951662457001, 0.5173516952759566, 0.5150949777319724, 0.5310161032914441, 0.5060334126764552, 0.5165341785035373, 0.5143774551018738, 0.5075753109087975, 0.5571124598581485, 0.5161637033054187, 0.5791652586113485, 0.5075784646428366, 0.5184428238403, 0.5167980680397437, 0.5796166872168655, 0.5602423272856955, 0.520489899716715, 0.5833870028566641};
std::array<float, NB_STRINGS> damping_10k = { 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006 };

std::array<int, NB_STRINGS> nbMass_11k = { 545, 515, 458, 408, 385, 343, 306, 272, 257, 229, 204, 192, 171, 153, 136, 128, 114, 102, 96, 85, 76, 68, 64, 57, 51, 48, 42, 38, 34, 32, 28, 25, 24, 21, 19, 17, 16, 14, 12, 12, 10, 9, 8, 8, 7, 6, 6 };
std::array<float, NB_STRINGS> stiffness_11k = { 0.586765226820026, 0.587936694558197, 0.585638679922655, 0.5854642887514063, 0.585162747113832, 0.5852674801156705, 0.58707370832029, 0.5847277557939149, 0.5861174234249218, 0.5867484746507533, 0.5871842269113119, 0.584147452937701, 0.584462978899315, 0.5902617906202012, 0.5885136181985084, 0.5856710360262474, 0.5863978825660833, 0.5926504313607123, 0.5899747202321686, 0.5842808400738332, 0.5901247011322998, 0.5970369127258256, 0.594705514730019, 0.5965918737594991, 0.6041937202012452, 0.6021966108586501, 0.584311263446828, 0.6056052421896319, 0.6145504770761343, 0.6132458649017318, 0.5967453969834464, 0.6043934776897952, 0.6272321238401607, 0.6120818834528269, 0.6373888814990606, 0.6505698975684404, 0.6514244017247804, 0.6391962890670907, 0.6052633073299971, 0.6791401209982325, 0.613292569954444, 0.638816970338898, 0.6523067500047625, 0.7315969251221814, 0.728863520554601, 0.7041464908238502, 0.789237045862643 };
std::array<float, NB_STRINGS> damping_11k = { 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006};

std::array<int, NB_STRINGS> nbMass_12k = { 583, 550, 490, 436, 412, 367, 327, 291, 275, 245, 218, 206, 183, 163, 145, 137, 122, 109, 103, 91, 81, 72, 68, 61, 54, 51, 45, 40, 36, 34, 30, 27, 25, 22, 20, 18, 17, 15, 13, 12, 11, 10, 9, 8, 7, 6, 6 };
std::array<float, NB_STRINGS> stiffness_12k = { 0.6712814195762052, 0.6704002936182707, 0.6701424860047571, 0.6683691607091603, 0.6698874797225067, 0.6697809095923377, 0.67013622977073, 0.6689497792937547, 0.6707531283532794, 0.6712211949762954, 0.6701219391320306, 0.6719660120107654, 0.6688584775257951, 0.669405297053785, 0.6683728808489862, 0.6702391473928978, 0.6708161912470854, 0.6759356880095583, 0.6781904572621867, 0.6686430011651812, 0.6692415937229174, 0.6682527040072374, 0.670137491511681, 0.68169713055971, 0.6758975625631519, 0.6781662344839727, 0.6686496664087371, 0.6692767994607739, 0.6867430055391408, 0.6897733601824275, 0.6818100909985017, 0.7008358843618356, 0.6783468984281245, 0.6688935933433349, 0.7025868677159773, 0.724674714785832, 0.7300920239484413, 0.7269412622868527, 0.7014913084723774, 0.679140120998247, 0.7290758838036687, 0.7718643101719158, 0.8037619629547116, 0.7315969251221871, 0.7288635205546071, 0.704146490823851, 0.7892370458626438 };
std::array<float, NB_STRINGS> damping_12k = { 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006, 0.0006 };



std::array<int, NB_STRINGS> nbMasses;
std::array<float, NB_STRINGS> stiffness;
std::array<float, NB_STRINGS> damping;



std::array<float, NB_STRINGS> twangK;
std::array<float, NB_STRINGS> twangEnv;
std::array<float, NB_STRINGS> twangEnvDecay;

std::array<float, NB_STRINGS> curStiff;




int crossover = 0;